### 聊天软件集群服务端

### 主要思路：
单服务端思路：使用前面写的网络库作为基础，保存登录的客户端的所有连接，使用json进行序列化和客户端进行通信，写个服务类，然后封装对实体的数据库操作，对方在线就即时聊天，不在线就把消息放入数据库中，下次登录的时候读取数据发送过去。

增加集群功能：使用redis作为缓存，客户端登录后，服务器就在redis中发布该客户端在线状态，服务器在本机找不到客户端，就去redis上找，看在不在别的服务器中登录了，再找不到才是不在线状态，存储到数据库。这样就可以多台服务器构建为集群，提供聊天服务。

### 第一部分目标：
- 能启动服务端和模拟的客户端，服务端提供回声功能，被客户端使用。

#### 日志类的编写
**功能：**
- 接收不同的日志级别，根据日志级别组成字符串和打印位置，写入日志文件中
- 设置日志线程和写入文件线线程，根据日志数量和间隔时间进行刷盘。

#### 编写服务端启动的server类

**功能：**
- 设置服务器参数，回调。接收新连接和数据

### 第二部分目标：
设计数据库表，编写数据库连接池，编写实体类以及DAO层类，
#### 编写ConnectionPool类
**功能：**
- 读取数据库配置
- 保存有数据库连接队列，提供数据库连接获取接口。
- 管理数据库连接的动态增加和回收，删除
#### 编写Connection类
**功能：**
- 提供数据库连接接口，供连接池使用
- 提供数据库查询更新接口，供dao层使用。

#### 根据设计的数据表编写各实体类和dao类
- 编写user，group，offlinemessage实体类
- 编写userdao，frienddao,groupdao，offlinemessagedao类。

### 第三部分目标：
单服务器情况下，完成聊天功能，
编写通信协议，业务清单。
#### 服务器部分
#### 编写chatserver类，
**功能：**
- 设置服务器参数，启动服务器，
- 设置新连接回调，调用各种服务
#### 编写chatservice类
**功能：**
- 提供获取回调接口，供chatserver类获取
- 在这里处理所有功能，注册，登录，聊天，群聊等等功能并调用dao类来完成这些功能。
- 对收到的数据进行合法性验证以及序列化数据发送。
#### 编写RedisTool类
**功能：**
- 提供订阅发布接口，在专门的线程接收消息。
- 返回redis客户端接口，可通过客户端设置token
#### 编写TokenManager类，
**功能：**
- 根据用户id生成token，存入redis
- 提供token删除，查询接口。
#### 编写DbChecker和DbConfig
**功能:**
- 读取mysql配置文件，供连接池使用
- 检查数据库和表是否存在，不存在就根据文件里的mysql语句创建。
#### 客户端部分
#### 编写网络类clientNet
**功能:**
- 主要是连接服务器，发送数据，接收数据。供上层服务使用

#### 编写showUI类
**功能：**
- 在这里显示所有界面相关的显示和输入操作
- 通过输入的命令，调用服务类的服务，如果登录，注册，聊天，添加好友群组等等。
- 登录成功后，新建线程调用服务类的收数据服务。显示新消息。

#### 编写clientservice类。
**功能：**
- 保存当前登录用户的状态，供上层showUI类显示调用
- 提供服务给上层的showUI类
- 对收到的数据进行合法性验证以及序列化数据发送，调用网络类进行发送和接收数据

#### 第四部分目标：
- 修改单服务器为集群服务器
**思路：**
- 使用nginx反向代理，用户在登录时，根据配置的方式，如轮询地，从服务器集群中选择服务器登录。
- 用户A在M服务器登录时，把在线状态存入redis中，并向redis订阅该用户的名称的频道
用户B在N服务器向A发送消息，先在本地查找是否有用户b的连接，如果不在，在redis中查找是否在线
在线，则向redis中A的名称的频道发送消息。A收到消息。完成跨服务器通信的功能，集群功能完成。
#### 修改内容：
1、存储在线状态至redis
2、订阅userid频道

#### 第五部分，
- 编写rpc通信框架做成库文件，然后对服务端的服务类的一些服务进行包装，提供远程调用接口。
- 在自己写的newmuduo网络库中添加客户端功能，主动建立连接。
- 使用zookeeper管理提供服务的服务器列表
- 使用连接池连接每一个服务的服务器。通过服务名找可用tcp连接。
- 把登录服务，做成rpc，和主要的聊天服务等等进行分离。
